<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>One Graph</title>
    <script type="text/javascript" src="../../vendor/d3/d3.v2.js"></script>
    <style type="text/css">
body {
  font: 13px sans-serif;
}

rect {
  fill: #fff;
}

ul {
  list-style-type: none;
  margin: 0.5em 0em 0.5em 0em;
  width: 100%; }
  ul li {
    display: table-cell;
    vertical-align: middle;
    margin: 0em;
    padding: 0em 1em; }

#chart1 {
    background-color: #F7F2C5;
    width: 960px;
    height: 500px;
}

.axis {
  font-size: 1.5em; 
}

circle, .line {
  fill: none;
  stroke: steelblue;
  stroke-width: 2px; }

circle {
  fill: white;
  fill-opacity: 0.2;
  cursor: move; }
  circle.selected {
    fill: #ff7f0e;
    stroke: #ff7f0e; }
  circle:hover {
    stroke: #ff7f0e; }

    </style>
  </head>
  <body>
    <div id="chart1"></div>
    <script type="text/javascript">

var graph = {
  "xmax": 60,
  "xmin": 0,
  "ymax": 40,
  "ymin": 0, 
  "title": "Simple Graph1",
  "xlabel": "X Axis",
  "ylabel": "Y Axis"  
};

var chart1 = document.getElementById("chart1"),
    cx = chart1.clientWidth,
    cy = chart1.clientHeight,
    padding = {
       "top":    graph.title  ? 40 : 20,
       "right":                 30,
       "bottom": graph.xlabel ? 60 : 10,
       "left":   graph.ylabel ? 70 : 45
    },
    size = {
      "width":  cx - padding.left - padding.right,
      "height": cy - padding.top  - padding.bottom
    },
    tx = function(d) { return "translate(" + x(d) + ",0)"; },
    ty = function(d) { return "translate(0," + y(d) + ")"; },
    stroke = function(d) { return d ? "#ccc" : "#666"; },
    yrange2 = (graph.ymax - graph.ymin) / 2,
    yrange4 = yrange2 / 2;
    points = d3.range(graph.xmin, graph.xmax/2).map(function(i) { 
      return { x: i*2, y: graph.ymin + yrange4 + Math.random() * yrange2 }; 
    });
    
    // x-scale
    x = d3.scale.linear()
        .domain([graph.xmin, graph.xmax])
        .range([0, size.width]),

    // drag x-axis logic
    downscalex = x.copy(),
    downx = Math.NaN,

    // y-scale (inverted domain)
    y = d3.scale.linear()
        .domain([graph.ymax, graph.ymin])
        .nice()
        .range([0, size.height])
        .nice(),
    line = d3.svg.line()
        .x(function(d, i) { return x(points[i].x); })
        .y(function(d, i) { return y(points[i].y); }),

    // drag y-axis logic
    downscaley = y.copy(),
    downy = Math.NaN,

    line = d3.svg.line()
        .x(function(d, i) { return x(points[i].x); })
        .y(function(d, i) { return y(points[i].y); }),

    dragged = selected = null;

var vis = d3.select(chart1).append("svg")
    .attr("width", cx)
    .attr("height", cy)
    .append("g")
      .attr("transform", "translate(" + padding.left + "," + padding.top + ")");

var plot = vis.append("rect")
    .attr("width", size.width)
    .attr("height", size.height)
    .style("fill", "#EEEEEE")
    .attr("pointer-events", "all")
    .on("mousedown.drag", plot_drag)
    .on("touchstart.drag", plot_drag);

// special-case change in d3.behavior.zoom coming in v2.8.0
if (d3.behavior.zoom().x) {
  plot.call(d3.behavior.zoom().x(x).y(y).scaleExtent([1, 8]).on("zoom", redraw));
} else {
  plot.call(d3.behavior.zoom().on("zoom", redraw));
}

vis.append("svg")
    .attr("top", 0)
    .attr("left", 0)
    .attr("width", size.width)
    .attr("height", size.height)
    .attr("viewBox", "0 0 "+size.width+" "+size.height)
    .attr("class", "line")
    .append("path")
        .attr("class", "line")
        .attr("d", line(points))

// add Chart Title
if (graph.title) {
  vis.append("text")
      .attr("class", "axis")
      .text(graph.title)
      .attr("x", size.width/2)
      .attr("dy","-0.8em")
      .style("text-anchor","middle");
}

// Add the x-axis label
if (graph.xlabel) {
  vis.append("text")
      .attr("class", "axis")
      .text(graph.xlabel)
      .attr("x", size.width/2)
      .attr("y", size.height)
      .attr("dy","2.4em")
      .style("text-anchor","middle");
}

// add y-axis label
if (graph.ylabel) {
  vis.append("g").append("text")
      .attr("class", "axis")
      .text( graph.ylabel)
      .style("text-anchor","middle")
      .attr("transform","translate(" + -40 + " " + size.height/2+") rotate(-90)");
}

d3.select(window)
    .on("mousemove.drag", mousemove)
    .on("touchmove.drag", mousemove)
    .on("mouseup.drag",   mouseup)
    .on("touchend.drag",  mouseup)
    .on("keydown", keydown);

// attach the mousemove and mouseup to the body
// in case one wonders off the axis line

d3.select('body')
  .on("mousemove.drag", axis_scale)
  .on("touchmove.drag", axis_scale)
  .on("mouseup",        axis_scale_end)
  .on("touchend.drag",  axis_scale_end);

function plot_drag() {
  d3.select('body').style("cursor", "move");
  if (d3.event.altKey) {
    var m = d3.svg.mouse(vis.node());
    var newpoint = {};
    newpoint.x = x.invert(Math.max(0, Math.min(size.width, m[0])));
    newpoint.y = y.invert(Math.max(0, Math.min(size.height, m[1])));
    points.push(newpoint);
    points.sort(function(a, b) {
      if (a.x < b.x) { return -1 };
      if (a.x > b.x) { return  1 };
      return 0
    });
    selected = newpoint;
    update();
    d3.event.preventDefault();
    d3.event.stopPropagation();
  }
};

function update() {
  var lines = vis.select("path").attr("d", line(points));
        
  var circle = vis.select("svg").selectAll("circle")
      .data(points, function(d) { return d; });

  circle.enter().append("circle")
      .attr("class", function(d) { return d === selected ? "selected" : null; })
      .attr("cx",    function(d) { return x(d.x); })
      .attr("cy",    function(d) { return y(d.y); })
      .attr("r", 10.0)
      .style("cursor", "ns-resize")
      .on("mousedown.drag",  datapoint_drag)
      .on("touchstart.drag", datapoint_drag);

  circle
      .attr("class", function(d) { return d === selected ? "selected" : null; })
      .attr("cx",    function(d) { return x(d.x); })
      .attr("cy",    function(d) { return y(d.y); });

  circle.exit().remove();

  if (d3.event && d3.event.keyCode) {
    d3.event.preventDefault();
    d3.event.stopPropagation();
  }
}

function datapoint_drag(d) {
  document.onselectstart = function() { return false; };
  selected = dragged = d;
  update();
};


function mousemove() {
  if (!dragged) return;
  var m = d3.svg.mouse(vis.node());
  dragged.y = y.invert(Math.max(0, Math.min(size.height, m[1])));
  update();
}

function mouseup() {
  document.onselectstart = function() { return true; };
  d3.select('body').style("cursor", "auto");
  if (!dragged) return;
  mousemove();
  dragged = null;
}

function keydown() {
  if (!selected) return;
  switch (d3.event.keyCode) {
    case 8: // backspace
    case 46: { // delete
      var i = points.indexOf(selected);
      points.splice(i, 1);
      selected = points.length ? points[i > 0 ? i - 1 : 0] : null;
      update();
      break;
    }
  }
};

function redraw() {
  // needed for pre v2.8.0
  if (d3.event && d3.event.transform && isNaN(downx) && isNaN(downy)) {
      d3.event.transform(x, y);
  };

  var fx = x.tickFormat(10),
      fy = y.tickFormat(10);

  // Regenerate x-ticks…
  var gx = vis.selectAll("g.x")
      .data(x.ticks(10), String)
      .attr("transform", tx);

  gx.select("text")
      .text(fx);

  var gxe = gx.enter().insert("g", "a")
      .attr("class", "x")
      .attr("transform", tx);

  gxe.append("line")
      .attr("stroke", stroke)
      .attr("y1", 0)
      .attr("y2", size.height);

  gxe.append("text")
      .attr("class", "axis")
      .attr("y", size.height)
      .attr("dy", "1em")
      .attr("text-anchor", "middle")
      .text(fx)
      .style("cursor", "ew-resize")
      .on("mouseover", function(d) { d3.select(this).style("font-weight", "bold");})
      .on("mouseout",  function(d) { d3.select(this).style("font-weight", "normal");})
      .on("mousedown.drag",  xaxis_drag)
      .on("touchstart.drag", xaxis_drag);

  gx.exit().remove();

  // Regenerate y-ticks…
  var gy = vis.selectAll("g.y")
      .data(y.ticks(10), String)
      .attr("transform", ty);

  gy.select("text")
      .text(fy);

  var gye = gy.enter().insert("g", "a")
      .attr("class", "y")
      .attr("transform", ty)
      .attr("background-fill", "#FFEEB6");

  gye.append("line")
      .attr("stroke", stroke)
      .attr("x1", 0)
      .attr("x2", size.width);

  gye.append("text")
      .attr("class", "axis")
      .attr("x", -3)
      .attr("dy", ".35em")
      .attr("text-anchor", "end")
      .text(fy)
      .style("cursor", "ns-resize")
      .on("mouseover", function(d) { d3.select(this).style("font-weight", "bold");})
      .on("mouseout",  function(d) { d3.select(this).style("font-weight", "normal");})
      .on("mousedown.drag",  yaxis_drag)
      .on("touchstart.drag", yaxis_drag);

  gy.exit().remove();
  update();
}

function xaxis_drag(d) {
  document.onselectstart = function() { return false; };
  var p = d3.svg.mouse(vis[0][0]);
  downx = x.invert(p[0]);
  downscalex = null;
  downscalex = x.copy();
};

function yaxis_drag(d) {
  document.onselectstart = function() { return false; };
  var p = d3.svg.mouse(vis[0][0]);
  downy = y.invert(p[1]);
  downscaley = y.copy();
}

function axis_scale(d) {
  var d3_behavior_dragTarget = this,
      p = d3.svg.mouse(vis[0][0]),
      t = d3.event.changedTouches;
  
  if (!isNaN(downx)) {
    d3.select('body').style("cursor", "ew-resize");
    var rupx = downscalex.invert(p[0]),
    xaxis1 = downscalex.domain()[0],
    xaxis2 = downscalex.domain()[1],
    xextent = xaxis2 - xaxis1;
    if (rupx != 0) {
      var changex, new_domain;
      changex = downx / rupx;
      new_domain = [xaxis1, xaxis1 + (xextent * changex)];
      x.domain(new_domain);
      redraw();
    }
    d3.event.preventDefault();
    d3.event.stopPropagation();
  };
  if (!isNaN(downy)) {
    d3.select('body').style("cursor", "ns-resize");
    var rupy = downscaley.invert(p[1]),
    yaxis1 = downscaley.domain()[1],
    yaxis2 = downscaley.domain()[0],
    yextent = yaxis2 - yaxis1;
    if (rupy != 0) {
      var changey, new_domain;
      changey = downy / rupy;
      new_domain = [yaxis1 + (yextent * changey), yaxis1];
      y.domain(new_domain);
      redraw();
    }
    d3.event.preventDefault();
    d3.event.stopPropagation();
  }
};

function axis_scale_end(d) {
  document.onselectstart = function() { return true; };
  d3.select('body').style("cursor", "auto");
  if (!isNaN(downx)) {
    redraw();
    downx = Math.NaN;
    d3.event.preventDefault();
    d3.event.stopPropagation();
  };
  if (!isNaN(downy)) {
    redraw();
    downy = Math.NaN;
    d3.event.preventDefault();
    d3.event.stopPropagation();
  };
};

redraw();


    </script>

  </body>
</html>
